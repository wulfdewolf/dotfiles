- name: Install Alacritty build dependencies
  ansible.builtin.apt:
    name:
      - cmake
      - pkg-config
      - libfreetype6-dev
      - libfontconfig1-dev
      - libxcb-xfixes0-dev
      - libxkbcommon-dev
      - python3
      - build-essential
      - curl
      - git
    state: present
  become: true

- name: Clone Alacritty repo to user cache dir
  ansible.builtin.git:
    repo: https://github.com/alacritty/alacritty.git
    dest: "{{ ansible_env.HOME }}/.cache/alacritty"
    update: yes
  become: false

# Your build or install steps here, e.g.
- name: Build Alacritty
  ansible.builtin.command:
    cmd: cargo build --release
    chdir: "{{ ansible_env.HOME }}/.cache/alacritty"
  become: false
  environment:
    PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"

- name: Copy Alacritty binary to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ ansible_env.HOME }}/.cache/alacritty/target/release/alacritty"
    dest: /usr/local/bin/alacritty
    mode: '0755'
  become: yes

# Cleanup: Remove the cloned repo directory
- name: Remove Alacritty build directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.cache/alacritty"
    state: absent
  become: false

- name: Register alacritty as x-terminal-emulator alternative
  ansible.builtin.command:
    cmd: >
      update-alternatives --install
      /usr/bin/x-terminal-emulator
      x-terminal-emulator
      /usr/bin/alacritty
      50
  become: yes

- name: Set alacritty as default x-terminal-emulator
  ansible.builtin.command:
    cmd: update-alternatives --set x-terminal-emulator /usr/bin/alacritty
  become: yes
